# vsearch

Image search engine built on FAISS, designed to work on medium- and large-scale datasets.

## Overview

- Index feature vectors
  - FAISS index for k-NN lookups
  - SQLite database relates image IDs to hash and frame number
- Search the feature vectors using a Flask app

## Requirements

- Python 3.5
- `pip install -r requirements.txt`
- `conda install faiss-cpu -c pytorch`
- `conda install pytorch -c pytorch`

## Datasets

Organize your datasets of feature vectors:

- `./datasets/`
  - `:name/`
    - `sample.pkl` (sampling of vectors for training PCA, optional)
    - `data/*.pkl` (pickled feature vectors)
    - `indexes/sqlite3.db` (generated by indexing process)
    - `indexes/faiss-:factory_type.index` (generated by indexing process)

VSearch expects PKL files containing feature vectors with the following structure:

- `data['photos'][:hash]['metadata'][:field] = vec`
- `data['videos'][:hash]['metadata'][:field][:frame] = vec`

Optionally, you can index multiple vectors per video. Set the flag "multiple" in the recipe, and use the following data structure:

- `data['videos'][:hash]['metadata'][:field][:frame] = [vecs]`

### Recipes

The JSON files in `recipes` are suitable for both medium and large setups.  The JSON should contain these fields:

- `dataset` - Directory in "datasets" which contains the dataset
- `gpu` - Whether this recipe uses the GPU (for most indexes this is false)
- `features` - Options for feature extractor
  - `framework` - `"pytorch"` or `"keras"`
  - `net` - Network to use (see feature_extractor.py)
  - `weights` - Specify network weights for keras
  - `dimension` - Dimension of vectors to be indexed
  - `field` - Name of the metadata field which contains the frames/vectors
  - `multiple` - Whether to index multiple vectors per image
- `faiss` - Options for FAISS
  - `factory_type` - Standard factory type to use (see below)
  - `test_factory_types` - Array of factories to generate if testing
  - `train` - Specify "dataset" to train on the whole dataset, or a file in the dataset e.g. `data/verified.pkl`
- `storage` - Options for storage
  - `mode` - `"s3"` or `"local"`
  - `endpoint` - If S3, this is the base HREF of our files. If local, this is the base path. If using local storage, make sure your images are accessible from the same URL on your local endpoint.

## Indexing

Set up your dataset and recipe file.  From the root folder, run:

```
python ./faiss_db/train.py --config ./recipes/db_medium.json --store_db
```

This will build the FAISS index and the SQLite3 database.

### Running a query

To do a basic search using an image, use the query script:

```
python ./query.py --config ./recipes/db_medium.json --query example.jpg
```

### Comparing indexes

FAISS supports many different clustering algorithms.  Since it does not take long to build these indexes, it is good to make a few variants to see how well they perform.  In the recipe, specify an array of `test_factory_types` you're curious about, and then run this command to generate them all at once:

```
python ./faiss_db/train.py --config ./recipes/db_medium.json --store_timing --test_factory_types
```

Timing data is written to `timing.csv`.  Next, you can test the indexes on random images from the dataset to see how it performs:

```
python ./faiss_db/test.py --config ./recipes/db_medium.json --test_count 10
```

This will test 10 random images against each of the networks found in `datasets/:name/index/` and produce an HTML file in `datasets/:name/web/`.  Image paths are according to VFrame convention.

### Statistics

#### Medium-sized datasets

- ~5K videos = ~106k feature vectors
- Feature vectors fit in RAM, but FAISS produces a much smaller index.
- Images and videos are only a few GB and can be stored in the cloud (S3)

Tested index of 106K 4096-dim AlexNet feature vectors using FAISS, run on a 2015 Macbook Pro.

| Factory Type | Train time | Add time | Search time | Index size | Notes
|---|---|---|---|---|---|
Flat|0.0s|0.9s|0.1s|1.7 GB|baseline
PCA80,Flat|0.0s|0.4s|0.0s|102 MB|good
IVF4096,Flat|0.0s|26.2s|0.0s|1.8 GB|
IVF512,Flat|30.8s|5.3s|0.0s|1.8 GB|
IVF512,SQ4|38.3s|3.6s|0.0s|227 MB|
IVF512,SQ8|34.4s|3.2s|0.0s|445 MB|good
IVF4096,SQ8|259.5s|23.1s|0.0s|504 MB|
PCAR8,IMI2x10,SQ8|25.3s|0.7s|0.0s|70 MB|

#### Large-sized datasets

- ~1.5M videos = ~40M feature vectors
- Feature vectors do not fit in RAM - split into multiple PKL files
- Excessive number of videos should not be stored in the cloud - store them locally and proxy them.

The FAISS documentation recommends using a factory type of IMI2x10,Flat (high memory usage) or PCAR8,IMI2x10,SQ8 (low memory usage, worse index quality).  More on that when we are able to test it.

## Searching

### Flask app

After building your index, you can use the VSearch Flask app to query it.  Run the Flask server, then navigate to http://0.0.0.0:8000/

```
python ./server.py --config ./recipes/db_medium.json
```

The database can be queried in a few different ways:

- Uploaded image
- Remote URL
- Feature vector from database (lookup by video hash + frame)
- Random feature vector
